```python
from pyspark.sql import SparkSession
from pyspark import SparkConf
from IPython.display import display
from pyspark.sql.functions import *
from pyspark.sql import DataFrame, Window

from spotify_secret import spark_config, hdfs_path

'''
Inicjacja sparkSession z odpowiednimi parametrami
'''
conf = SparkConf().setAll([(key, value) for key, value in spark_config.items()])

spark = SparkSession \
            .builder \
            .master('yarn') \
            .config(conf=conf) \
            .getOrCreate()
```


```python
'''
Do zrobienia: wyliczenie delty z "energy", "dancability" w kolejnych latach. 
Czyli dla roku n pokazujesz o ile zmienil sie wspolczynnik "energy"
i "dancebility" w stosunku do roku n-1. 
Kod wystaw proszę gdzies na gitlabie/githubie. Bonus points za testy.
'''
```


```python
'''
Dane zostały pobrane oraz wczytane na hdfs - dla tej konkretnie csvki nie jest
to oczywiście potrzebne bo jest ona niewielkich rozmiarów, ale jest to docelowo
preferowana metoda wczytywania surowych plików do sparka.
'''
```


```python
'''
Wczytanie danych wejściowych do sparka: data_by_year.csv
'''
spotify_path = f'{hdfs_path}/data_by_year.csv'
spotify = spark.read.format('csv').options(header='true', inferSchema='true').load(spotify_path)


'''
Eksploracja zbioru, sprawdzenie czy struktura została poprawnie wczytana (typy zmiennych).
'''
spotify.printSchema()
spotify.show(truncate = False)
```

    root
     |-- year: integer (nullable = true)
     |-- acousticness: double (nullable = true)
     |-- danceability: double (nullable = true)
     |-- duration_ms: double (nullable = true)
     |-- energy: double (nullable = true)
     |-- instrumentalness: double (nullable = true)
     |-- liveness: double (nullable = true)
     |-- loudness: double (nullable = true)
     |-- speechiness: double (nullable = true)
     |-- tempo: double (nullable = true)
     |-- valence: double (nullable = true)
     |-- popularity: double (nullable = true)
     |-- key: integer (nullable = true)
     |-- mode: integer (nullable = true)
    
    +----+------------------+-------------------+------------------+-------------------+-------------------+-------------------+-------------------+-------------------+------------------+-------------------+-------------------+---+----+
    |year|acousticness      |danceability       |duration_ms       |energy             |instrumentalness   |liveness           |loudness           |speechiness        |tempo             |valence            |popularity         |key|mode|
    +----+------------------+-------------------+------------------+-------------------+-------------------+-------------------+-------------------+-------------------+------------------+-------------------+-------------------+---+----+
    |1920|0.6312422636103152|0.515750143266476  |238092.9971346705 |0.41869957020057297|0.35421854404011477|0.2160492836676219 |-12.654020057306598|0.0829836676217765 |113.22689971346703|0.49821002865329533|0.6103151862464183 |2  |1   |
    |1921|0.8621051282051285|0.432170512820513  |257891.7628205128 |0.2411363461538462 |0.33715828737179476|0.2052185897435897 |-16.811660256410242|0.07895192307692306|102.42539743589741|0.37827564102564093|0.391025641025641  |2  |1   |
    |1922|0.8289338842975207|0.5756198347107437 |140135.14049586776|0.22617264462809922|0.25477550206611577|0.25666198347107444|-20.84008264462809 |0.46436776859504136|100.03314876033059|0.5711900826446279 |0.09090909090909091|5  |1   |
    |1923|0.9572467913513517|0.5773405405405401 |177942.36216216217|0.2624064864864865 |0.3717327250270269 |0.22746216216216206|-14.129210810810811|0.09394864864864867|114.01072972972973|0.6254924324324328 |5.205405405405405  |0  |1   |
    |1924|0.9401998601694928|0.5498940677966102 |191046.70762711865|0.3443466101694912 |0.5817009136440676 |0.23521906779661   |-14.231343220338985|0.092089406779661  |120.68957203389823|0.6637254237288138 |0.6610169491525424 |10 |1   |
    |1925|0.962701648745521 |0.5748745519713262 |184777.62365591398|0.2780860215053763 |0.4201959369892471 |0.2372068100358422 |-14.165354838709673|0.11166845878136207|115.47983154121863|0.6211870967741934 |2.6702508960573477 |5  |1   |
    |1926|0.6663868848758487|0.5969149736644092 |157836.34988713317|0.21050642588412327|0.33609341770504125|0.2320212942061703 |-18.48742287434162 |0.4779189616252817 |109.57097215951842|0.4370937622272383 |1.436418359668924  |9  |1   |
    |1927|0.9158258200000028|0.6559293333333329 |176542.812        |0.26790213333333335|0.32099203556      |0.17738653333333335|-15.235275999999976|0.26191533333333306|112.66370666666654|0.6696757333333335 |0.684              |1  |1   |
    |1928|0.9391407145098026|0.5349066666666661 |214396.03215686276|0.2088558196078431 |0.4909548132156862 |0.17465733333333328|-17.13142352941175 |0.15864533333333336|106.74906196078446|0.49741231372549016|1.4533333333333334 |1  |1   |
    |1929|0.6010148370136718|0.6478398527865401 |168795.60988433228|0.24190778128285972|0.2154050868243956 |0.2359770767613036 |-16.533055730809654|0.4904637223974763 |110.92671083070452|0.6368048370136701 |0.31440588853838064|7  |1   |
    |1930|0.9356248883881173|0.5197101802757159 |194691.10286320254|0.33485984093319204|0.35186930079003176|0.22063483563096506|-12.823486744432675|0.12019793213149518|109.9247884411452 |0.6160890774125142 |0.8510074231177094 |5  |1   |
    |1931|0.8331824380165301|0.5948927685950423 |171564.24483471076|0.23473644938016547|0.22192114648760364|0.22724628099173552|-16.509507231404942|0.4527522727272729 |108.97437809917368|0.5128472107438018 |0.22107438016528927|0  |1   |
    |1932|0.7733629156010245|0.6022140664961636 |174763.5230179028 |0.27836227621483395|0.15546704255754482|0.21875447570332496|-16.459603580562646|0.41988734015345264|110.47795268542204|0.5988533248081837 |1.7838874680306904 |1  |1   |
    |1933|0.8908802495726501|0.5700692307692304 |196407.0811965812 |0.2867542735042735 |0.18238781868945858|0.20972108262108252|-12.972915954415965|0.09092806267806268|112.59650427350425|0.5986485754985753 |6.873219373219373  |7  |1   |
    |1934|0.888513707216495 |0.529168384879725  |189385.65120274914|0.2635702749140894 |0.27616513938144366|0.21272680412371134|-14.755116838487972|0.10207130584192432|115.40552920962193|0.558806013745705  |1.309278350515464  |0  |1   |
    |1935|0.7794678283151818|0.554997053171045  |221102.22421524665|0.24662291479820622|0.22365544707238946|0.2296258167841127 |-15.405760409993599|0.3550445227418322 |110.72258744394634|0.5445181934657274 |1.3721973094170403 |7  |1   |
    |1936|0.6019832632999995|0.6233780500000001 |172978.595        |0.2640076749500002 |0.11850880667999991|0.21355614999999972|-19.123150000000006|0.6271309499999987 |108.39304699999988|0.5612937999999996 |2.6635             |1  |1   |
    |1937|0.8655405612708025|0.5426403933434191 |223035.1921331316 |0.31051245083207246|0.3286776088048414 |0.22534009077155823|-13.120916792738273|0.08578350983358546|115.16774281391821|0.5850388804841145 |3.281391830559758  |7  |1   |
    |1938|0.9136303530546632|0.48051045016077204|247940.72186495177|0.2812483922829584 |0.37636335974276536|0.2360196141479098 |-14.307977491961415|0.09528697749196152|111.64432475884244|0.5146599839228292 |2.072347266881029  |0  |1   |
    |1939|0.9090123100000007|0.5136558000000002 |220997.613        |0.2848278000000002 |0.28158795441000023|0.24085729999999994|-13.847035000000005|0.12867819999999994|113.32418199999996|0.5612246999999995 |4.096              |0  |1   |
    +----+------------------+-------------------+------------------+-------------------+-------------------+-------------------+-------------------+-------------------+------------------+-------------------+-------------------+---+----+
    only showing top 20 rows
    



```python
'''
Selekcja odpowiednich kolumn: 'year', 'danceability', 'energy'
'''
spotify = spotify.select('year', 'danceability', 'energy')


'''
Przygotowanie funckji window - porządkuje zbiór danych malejąco, a następnie
iteruje po kolejnych parach kolumny 'year' i oblicza różnicę wartości
kolumn 'danceability' oraz 'energy' w stosunku do roku poprzedniego, dodając wyniki
do kolumn, kolejno: 'danceability_delta' oraz 'energy_delta'
'''
w = Window.orderBy(spotify.year.desc())

spotify = spotify \
                .withColumn('danceability_delta', spotify.danceability - lead('danceability').over(w)) \
                .withColumn('energy_delta', spotify.energy - lead('energy').over(w))

'''
Wyświetlenie pierwszych 20 krotek wynikowego dataframe
'''
spotify.show(truncate = False)
```

    +----+------------------+------------------+----------------------+---------------------+
    |year|danceability      |energy            |danceability_delta    |energy_delta         |
    +----+------------------+------------------+----------------------+---------------------+
    |2021|0.6524883695652172|0.5788958315217388|0.047202994623437355  |-0.09535157881826872 |
    |2020|0.6052853749417798|0.6742474103400076|0.0021839580246476586 |0.044466280670622305 |
    |2019|0.6031014169171321|0.6297811296693853|3.705031367334799E-4  |-0.029770963182495058|
    |2018|0.6027309137803987|0.6595520928518803|0.02225572825164157   |-0.026839727231607657|
    |2017|0.5804751855287571|0.686391820083488 |-0.0011073602353967038|0.029844844434276485 |
    |2016|0.5815825457641538|0.6565469756492115|0.021127545764153655  |0.06526846912747342  |
    |2015|0.5604550000000001|0.5912785065217381|-0.025698063943161875 |-0.07349921230596945 |
    |2014|0.586153063943162 |0.6647777188277075|-0.007727599672397556 |-0.02781719280463557 |
    |2013|0.5938806636155596|0.6925949116323431|0.035039418082125184  |0.005531220973843398 |
    |2012|0.5588412455334344|0.6870636906584997|-0.018098412491937332 |0.029299265948075748 |
    |2011|0.5769396580253717|0.657764424710424 |-0.022679923820625447 |4.091671887505033E-4 |
    |2010|0.5996195818459972|0.6573552575216735|0.033618941231007504  |-0.036890168487295316|
    |2009|0.5660006406149897|0.6942454260089688|0.012054180174775553  |0.022386285854300025 |
    |2008|0.5539464604402141|0.6718591401546687|-0.0033765530530383003|-0.018540042753878327|
    |2007|0.5573230134932524|0.6903991829085471|0.012970254111354107  |0.033199558184484945 |
    |2006|0.5443527593818983|0.6571996247240621|-0.012628665940316308 |-0.004951652000729001|
    |2005|0.5569814253222146|0.6621512767247911|-0.013574977690968049 |-0.010119062258260092|
    |2004|0.5705564030131827|0.6722703389830512|-0.004373422936184923 |0.022233764615961826 |
    |2003|0.5749298259493676|0.6500365743670894|0.005345397725523338  |0.01991924492669972  |
    |2002|0.5695844282238443|0.6301173294403897|-0.022223217036094867 |-0.013159877491312755|
    +----+------------------+------------------+----------------------+---------------------+
    only showing top 20 rows
    



```python
'''
Zapis wyników do pojedynczego pliku csv
'''

spotify.coalesce(1).write.csv(f'{hdfs_path}/spotify.csv')

```
